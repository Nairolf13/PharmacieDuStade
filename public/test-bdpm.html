<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test BDPM - Pharmacie</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
    button { padding: 10px 20px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #45a049; }
    #results { margin-top: 10px; max-height: 300px; overflow-y: auto; }
    .result-item { padding: 10px; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <h1>üß™ Test de la Base de Donn√©es BDPM</h1>
  
  <div class="test-section">
    <h2>üìä Statistiques de la base de donn√©es</h2>
    <div id="stats">Chargement...</div>
    <button onclick="loadStats()">Recharger les statistiques</button>
  </div>

  <div class="test-section">
    <h2>üîç Test de recherche</h2>
    <input type="text" id="searchInput" placeholder="Rechercher un m√©dicament..." style="width: 300px; padding: 10px;">
    <button onclick="testSearch()">Rechercher</button>
    <button onclick="testCommonDrugs()">Tester m√©dicaments courants</button>
    <div id="searchResults"></div>
  </div>

  <div class="test-section">
    <h2>üìã R√©sultats de test</h2>
    <div id="results"></div>
  </div>

  <script>
    let medicaments = [];

    async function loadStats() {
      const statsDiv = document.getElementById('stats');
      statsDiv.innerHTML = 'Chargement...';
      
      try {
        const response = await fetch('/bdpm.csv');
        const csvText = await response.text();
        const lines = csvText.split('\\n').filter(line => line.trim());
        
        const parsedData = lines.map(line => {
          const columns = line.split('\\t');
          if (columns.length >= 12) {
            return {
              commercialisation: columns[6],
              statut: columns[4],
              forme: columns[2]
            };
          }
          return null;
        }).filter(Boolean);

        medicaments = parsedData;
        
        const commercialises = parsedData.filter(m => m.commercialisation === 'Commercialis√©e').length;
        const autorises = parsedData.filter(m => m.statut === 'Autorisation active').length;
        
        const formes = {};
        parsedData.forEach(m => {
          formes[m.forme] = (formes[m.forme] || 0) + 1;
        });
        const formesPrincipales = Object.entries(formes)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5);

        statsDiv.innerHTML = \`
          <div class="success">‚úÖ Base de donn√©es charg√©e avec succ√®s!</div>
          <p><strong>Total:</strong> \${parsedData.length} m√©dicaments</p>
          <p><strong>Commercialis√©s:</strong> \${commercialises} m√©dicaments</p>
          <p><strong>Autoris√©s:</strong> \${autorises} m√©dicaments</p>
          <p><strong>Formes principales:</strong></p>
          <ul>
            \${formesPrincipales.map(([forme, count]) => \`<li>\${forme}: \${count}</li>\`).join('')}
          </ul>
        \`;
      } catch (error) {
        statsDiv.innerHTML = \`<div class="error">‚ùå Erreur: \${error.message}</div>\`;
      }
    }

    async function testSearch() {
      const searchTerm = document.getElementById('searchInput').value;
      const resultsDiv = document.getElementById('searchResults');
      
      if (!searchTerm.trim()) {
        resultsDiv.innerHTML = '<div class="error">‚ö†Ô∏è Veuillez entrer un terme de recherche</div>';
        return;
      }

      resultsDiv.innerHTML = 'Recherche en cours...';
      
      try {
        const searchLower = searchTerm.toLowerCase();
        const results = medicaments
          .filter(med => med.nom && med.nom.toLowerCase().includes(searchLower))
          .filter(med => med.commercialisation === 'Commercialis√©e')
          .slice(0, 10);

        if (results.length === 0) {
          resultsDiv.innerHTML = \`<div class="info">‚ÑπÔ∏è Aucun r√©sultat pour "\${searchTerm}"</div>\`;
        } else {
          resultsDiv.innerHTML = \`
            <div class="success">‚úÖ \${results.length} r√©sultat(s) trouv√©(s)</div>
            \${results.map(r => \`<div class="result-item"><strong>\${r.nom}</strong><br><small>\${r.forme} - \${r.voie}</small></div>\`).join('')}
          \`;
        }
      } catch (error) {
        resultsDiv.innerHTML = \`<div class="error">‚ùå Erreur de recherche: \${error.message}</div>\`;
      }
    }

    async function testCommonDrugs() {
      const commonDrugs = ['parac√©tamol', 'ibuprof√®ne', 'aspirine', 'doliprane', 'advil'];
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<h3>Test des m√©dicaments courants:</h3>';
      
      for (const drug of commonDrugs) {
        const searchLower = drug.toLowerCase();
        const results = medicaments
          .filter(med => med.nom && med.nom.toLowerCase().includes(searchLower))
          .filter(med => med.commercialisation === 'Commercialis√©e');
        
        const status = results.length > 0 ? 'success' : 'error';
        const icon = results.length > 0 ? '‚úÖ' : '‚ùå';
        resultsDiv.innerHTML += \`<div class="\${status}">\${icon} \${drug}: \${results.length} r√©sultat(s)</div>\`;
      }
    }

    // Chargement automatique au d√©marrage
    window.onload = loadStats;
  </script>
</body>
</html>
